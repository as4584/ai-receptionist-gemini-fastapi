name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  backend-ai-receptionist:
    name: Backend (ai_receptionist)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ai_receptionist
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: |
          poetry install --no-root

      - name: Lint (ruff)
        run: |
          poetry run ruff check .

      - name: Format check (black)
        run: |
          poetry run black --check .

      - name: Run tests
        run: |
          poetry run pytest -q

      - name: Build package artifact
        run: |
          poetry build

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai_receptionist-dist
          path: ai_receptionist/dist/*

  backend-legacy:
    name: Backend (legacy root)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps (requirements.txt)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Linting tools for legacy area
          pip install ruff black

      - name: Lint legacy (ruff)
        run: |
          ruff check src tests

      - name: Format check legacy (black)
        run: |
          black --check src tests

      - name: Run legacy tests
        run: |
          pytest -q

  frontend:
    name: Frontend (conditional)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect frontend
        id: detect
        run: |
          if [ -f frontend/package.json ]; then echo "has_frontend=true" >> $GITHUB_OUTPUT; else echo "has_frontend=false" >> $GITHUB_OUTPUT; fi

      - name: Setup Node
        if: ${{ steps.detect.outputs.has_frontend == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        if: ${{ steps.detect.outputs.has_frontend == 'true' }}
        run: npm ci
        working-directory: frontend

      - name: Lint (eslint)
        if: ${{ steps.detect.outputs.has_frontend == 'true' }}
        run: |
          npx eslint .
        working-directory: frontend

      - name: Run tests
        if: ${{ steps.detect.outputs.has_frontend == 'true' }}
        run: |
          npm test -- --ci --silent
        working-directory: frontend
