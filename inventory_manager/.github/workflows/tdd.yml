name: TDD - Test & Coverage

on:
  push:
    branches: [ main, develop, 'feature/**', 'test/**', 'refactor/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.10"
  COVERAGE_THRESHOLD: 80

jobs:
  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: Cache Poetry dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pypoetry
          .venv
        key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          ${{ runner.os }}-poetry-
    
    - name: Install dependencies
      run: poetry install --no-root
    
    - name: Create mock service account
      run: |
        echo '{"type": "service_account", "project_id": "test"}' > service_account.json
    
    - name: Run unit tests
      run: |
        poetry run pytest tests/ \
          --ignore=tests/integration \
          -v \
          --tb=short \
          --color=yes
      env:
        PYTHONPATH: src
        GOOGLE_SERVICE_ACCOUNT_JSON: ./service_account.json
        GOOGLE_SHEET_NAME: Test Sheet
        LS_X_API_TOKEN: test_token
        LS_ACCOUNT_DOMAIN: test.domain
    
    - name: Run integration tests
      if: always()
      run: |
        poetry run pytest tests/integration/ \
          -v \
          --tb=short \
          --color=yes \
          -m "not slow"
      continue-on-error: true
      env:
        PYTHONPATH: src
        GOOGLE_SERVICE_ACCOUNT_JSON: ./service_account.json
        GOOGLE_SHEET_NAME: Test Sheet
        LS_X_API_TOKEN: test_token
        LS_ACCOUNT_DOMAIN: test.domain
    
    - name: Generate test report
      if: always()
      run: |
        poetry run pytest tests/ \
          --junit-xml=test-results.xml \
          --html=test-report.html \
          --self-contained-html
      continue-on-error: true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          test-results.xml
          test-report.html
        retention-days: 30

  coverage:
    name: Code Coverage Analysis
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      run: poetry install --no-root
    
    - name: Create mock service account
      run: |
        echo '{"type": "service_account", "project_id": "test"}' > service_account.json
    
    - name: Run tests with coverage
      run: |
        poetry run pytest tests/ \
          --cov=src \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}
      env:
        PYTHONPATH: src
        GOOGLE_SERVICE_ACCOUNT_JSON: ./service_account.json
        GOOGLE_SHEET_NAME: Test Sheet
        LS_X_API_TOKEN: test_token
        LS_ACCOUNT_DOMAIN: test.domain
    
    - name: Generate coverage badge
      run: |
        poetry run coverage-badge -o coverage.svg -f
      continue-on-error: true
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-inventory-manager
        fail_ci_if_error: false
      continue-on-error: true
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          coverage.xml
          htmlcov/
          coverage.svg
        retention-days: 90
    
    - name: Coverage summary
      run: |
        echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        poetry run coverage report --format=markdown >> $GITHUB_STEP_SUMMARY

  quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      run: poetry install --no-root
    
    - name: Run Ruff linting
      run: |
        poetry run ruff check src/ tests/ \
          --output-format=github
    
    - name: Run Ruff formatting check
      run: |
        poetry run ruff format src/ tests/ --check
    
    - name: Run mypy type checking
      run: |
        poetry run mypy src/ \
          --strict \
          --ignore-missing-imports \
          --show-error-codes \
          --pretty
      continue-on-error: true
    
    - name: Generate quality report
      if: always()
      run: |
        echo "## Code Quality Report" > quality-report.md
        echo "" >> quality-report.md
        echo "### Linting (Ruff)" >> quality-report.md
        poetry run ruff check src/ tests/ --statistics >> quality-report.md || true
        echo "" >> quality-report.md
        echo "### Type Checking (mypy)" >> quality-report.md
        poetry run mypy src/ --strict --ignore-missing-imports >> quality-report.md || true
    
    - name: Upload quality report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: quality-report
        path: quality-report.md
        retention-days: 30

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, coverage, quality]
    if: always()
    
    steps:
    - name: Check test status
      run: |
        TEST_STATUS="${{ needs.test.result }}"
        COVERAGE_STATUS="${{ needs.coverage.result }}"
        QUALITY_STATUS="${{ needs.quality.result }}"
        
        echo "Test Status: $TEST_STATUS"
        echo "Coverage Status: $COVERAGE_STATUS"
        echo "Quality Status: $QUALITY_STATUS"
        
        if [ "$TEST_STATUS" != "success" ]; then
          echo "âŒ Tests failed"
          exit 1
        fi
        
        if [ "$COVERAGE_STATUS" != "success" ]; then
          echo "âŒ Coverage below ${COVERAGE_THRESHOLD}%"
          exit 1
        fi
        
        if [ "$QUALITY_STATUS" != "success" ]; then
          echo "âš ï¸  Code quality issues detected (non-blocking)"
        fi
        
        echo "âœ… All TDD checks passed!"
    
    - name: Create summary
      run: |
        echo "# ðŸ§ª TDD Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Tests | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Coverage (â‰¥80%) | ${{ needs.coverage.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | ${{ needs.quality.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
